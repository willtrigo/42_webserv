name: Integration Tests

on:
  push:
    branches: [main, master, develop, "**feat**"]
  pull_request:
    branches: [main, master, develop]
  workflow_call:

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake valgrind netcat-openbsd

      - name: Cache Google Test
        id: cache-gtest
        uses: actions/cache@v5
        with:
          path: |
            /usr/local/lib/libgtest.a
            /usr/local/lib/libgtest_main.a
            /usr/local/include/gtest
          key: gtest-1.8.1-${{ runner.os }}

      - name: Install Google Test 1.8.1 (C++98 compatible)
        if: steps.cache-gtest.outputs.cache-hit != 'true'
        run: |
          cd tests/
          sudo ./install_gtest.sh

      - name: Cache project build
        uses: actions/cache@v5
        with:
          path: |
            build
            bin
          key: project-build-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.hpp', 'Makefile') }}
          restore-keys: |
            project-build-${{ runner.os }}-

      - name: Cache test build
        uses: actions/cache@v5
        with:
          path: |
            tests/build
            tests/bin
          key: test-build-${{ runner.os }}-${{ hashFiles('tests/**/*.cpp', 'tests/**/*.hpp', 'tests/Makefile') }}
          restore-keys: |
            test-build-${{ runner.os }}-

      - name: Build project
        timeout-minutes: 5
        run: |
          echo "ðŸ”¨ Building webserver..."
          make
          echo "âœ… Server built successfully"

      - name: Build tests
        timeout-minutes: 5
        run: |
          echo "ðŸ”¨ Building test suite..."
          cd tests/
          make
          echo "âœ… Tests built successfully"

      - name: List integration tests
        run: |
          echo "ðŸ“‹ Available integration tests:"
          cd tests/
          ./bin/test_runner --gtest_list_tests | grep -A 100 "Integration" || true
          echo ""
          echo "ðŸ“Š Test counts:"
          ./bin/test_runner --gtest_list_tests | grep "IntegrationTest\." | wc -l | xargs echo "  Test suites:"
          ./bin/test_runner --gtest_list_tests | grep "^  " | grep -v "IntegrationTest\." | wc -l | xargs echo "  Individual tests:"

      - name: Start server
        timeout-minutes: 2
        run: |
          echo "ðŸš€ Starting webserver..."
          ./bin/webserv > server.log 2>&1 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "Server started with PID: $SERVER_PID"

          # Give server time to start
          sleep 2

          # Check if server is still running
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "âŒ Server crashed during startup"
            cat server.log
            exit 1
          fi

          echo "âœ… Server process is running"

      - name: Run integration tests
        timeout-minutes: 20
        run: |
          echo "ðŸ§ª Running integration tests..."
          cd tests/

          # Run all integration tests (match the local Makefile behavior)
          ./bin/test_runner \
            --gtest_filter="*IntegrationTest.*" \
            --gtest_output=xml:integration-test-results.xml \
            2>&1 | tee /tmp/integration_test_output.txt || true

          echo "Integration tests completed"

          # Parse results to determine actual status
          TOTAL=$(grep -oP 'Running \K[0-9]+' /tmp/integration_test_output.txt | head -1 2>/dev/null || echo "0")
          PASSED=$(grep -c '^\[       OK \]' /tmp/integration_test_output.txt 2>/dev/null || echo "0")
          # Count only test result lines, not the summary list (stop at "tests, listed below:")
          FAILED=$(grep '^\[  FAILED  \]' /tmp/integration_test_output.txt | grep -v 'tests, listed below:' | wc -l 2>/dev/null || echo "0")

          echo "TEST_TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "TEST_PASSED=$PASSED" >> $GITHUB_ENV
          echo "TEST_FAILED=$FAILED" >> $GITHUB_ENV

          echo "ðŸ“Š Test Results: $PASSED/$TOTAL passed, $FAILED failed"

          # Exit with failure if any tests failed
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Stop server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ] && kill -0 $SERVER_PID 2>/dev/null; then
            echo "Sending SIGINT to server (PID: $SERVER_PID)..."
            kill -INT $SERVER_PID
            
            # Wait for graceful shutdown
            SHUTDOWN_TIMEOUT=10
            for i in $(seq 1 $SHUTDOWN_TIMEOUT); do
              if ! kill -0 $SERVER_PID 2>/dev/null; then
                echo "âœ… Server shut down gracefully"
                break
              fi
              sleep 1
            done
            
            # Force kill if still running
            if kill -0 $SERVER_PID 2>/dev/null; then
              echo "âš ï¸ Force killing server after timeout"
              kill -9 $SERVER_PID
            fi
          else
            echo "â„¹ï¸ Server already stopped"
          fi

      - name: Parse test results
        if: always()
        run: |
          echo "ðŸ“Š Integration Test Summary"
          echo "============================"

          if [ -f tests/integration-test-results.xml ]; then
            # Parse XML results
            TOTAL=$(grep -o 'tests="[0-9]*"' tests/integration-test-results.xml | head -1 | grep -o '[0-9]*')
            FAILURES=$(grep -o 'failures="[0-9]*"' tests/integration-test-results.xml | head -1 | grep -o '[0-9]*')
            ERRORS=$(grep -o 'errors="[0-9]*"' tests/integration-test-results.xml | head -1 | grep -o '[0-9]*')
            PASSED=$((TOTAL - FAILURES - ERRORS))
            
            echo "Total tests: $TOTAL"
            echo "Passed: $PASSED"
            echo "Failed: $FAILURES"
            echo "Errors: $ERRORS"
            
            # Generate summary for GitHub
            echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ‰ **All integration tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Some tests failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results XML not found"
            echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Test results file not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results
          path: |
            tests/integration-test-results.xml
            server.log

      - name: Check test status
        if: always()
        run: |
          FAILED=${TEST_FAILED:-0}
          TOTAL=${TEST_TOTAL:-0}
          PASSED=${TEST_PASSED:-0}

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "âŒ Integration tests failed: $FAILED/$TOTAL tests failed"
            echo ""
            
            # Show failed tests
            if [ -f tests/integration-test-results.xml ]; then
              echo "ðŸ“‹ Failed Tests:"
              grep '\[  FAILED  \]' /tmp/integration_test_output.txt 2>/dev/null | head -20
            fi
            
            echo ""
            echo "ðŸ“‹ Server log (last 100 lines):"
            tail -100 server.log
            exit 1
          else
            echo ""
            echo "âœ… All integration tests passed! ($PASSED tests)"
          fi

      - name: Run integration tests with Valgrind
        if: success()
        timeout-minutes: 25
        run: |
          echo "ðŸ” Running integration tests with Valgrind..."

          # Start server with Valgrind
          valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --log-file=valgrind-server.txt \
            ./bin/webserv > valgrind-server.log 2>&1 &
          VALGRIND_PID=$!
          echo "Server started under Valgrind with PID: $VALGRIND_PID"

          # Give server time to start
          sleep 3

          # Check if server is still running
          if ! kill -0 $VALGRIND_PID 2>/dev/null; then
            echo "âŒ Server crashed under Valgrind"
            cat valgrind-server.log
            exit 1
          fi

          echo "âœ… Server is running under Valgrind"

          # Run subset of integration tests (quick smoke test)
          echo "ðŸ§ª Running subset of integration tests..."
          cd tests/
          ./bin/test_runner \
            --gtest_filter="HttpServerIntegrationTest.GetRequestReturns200:HttpServerIntegrationTest.PostRequestReturns200Or201:HttpServerIntegrationTest.NonexistentFileReturns404:FileHandlerIntegrationTest.UploadFileViaPost:FileHandlerIntegrationTest.DownloadNonExistentFile" \
            || true

          # Stop server gracefully
          echo "ðŸ›‘ Stopping Valgrind server..."
          kill -INT $VALGRIND_PID

          # Wait for graceful shutdown
          for i in $(seq 1 10); do
            if ! kill -0 $VALGRIND_PID 2>/dev/null; then
              echo "âœ… Server shut down gracefully"
              break
            fi
            sleep 1
          done

          # Force kill if still running
          if kill -0 $VALGRIND_PID 2>/dev/null; then
            kill -9 $VALGRIND_PID
          fi

          # Check Valgrind results
          echo "ðŸ“‹ Valgrind summary:"
          if [ -f valgrind-server.txt ]; then
            tail -30 valgrind-server.txt
            
            # Check for memory leaks
            if grep -q "definitely lost: 0 bytes" valgrind-server.txt && \
               grep -q "indirectly lost: 0 bytes" valgrind-server.txt; then
              echo "âœ… No memory leaks detected during integration tests"
            else
              echo "âš ï¸ Memory leaks detected during integration tests"
              echo "## Valgrind Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ Memory leaks detected. See artifacts for details." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Valgrind results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: valgrind-integration-results
          path: |
            valgrind-server.txt
            valgrind-server.log

      - name: Final summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“Š INTEGRATION TEST WORKFLOW SUMMARY"
          echo "=========================================="
          echo ""
          echo "This workflow validates:"
          echo "  âœ“ Server compiles successfully"
          echo "  âœ“ Test suite compiles successfully"
          echo "  âœ“ Server starts and accepts connections"
          echo "  âœ“ All integration tests run against live server"
          echo "  âœ“ Server shuts down gracefully"
          echo "  âœ“ No memory leaks during testing (Valgrind)"
          echo ""
          echo "=========================================="
