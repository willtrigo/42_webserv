name: Unit Tests - Port

on:
  push:
    branches: [main, master, develop, "**feat**"]
  pull_request:
    branches: [main, master, develop]
  workflow_call:

jobs:
  unit-port:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake valgrind

      - name: Cache Google Test
        id: cache-gtest
        uses: actions/cache@v5
        with:
          path: |
            /usr/local/lib/libgtest.a
            /usr/local/lib/libgtest_main.a
            /usr/local/include/gtest
          key: gtest-1.8.1-${{ runner.os }}

      - name: Install Google Test 1.8.1 (C++98 compatible)
        if: steps.cache-gtest.outputs.cache-hit != 'true'
        run: |
          cd tests/
          sudo ./install_gtest.sh

      - name: Cache project build (webserver)
        uses: actions/cache@v5
        with:
          path: |
            build
            bin
          key: project-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.hpp', 'Makefile') }}
          restore-keys: |
            project-${{ runner.os }}-

      - name: Cache test build
        uses: actions/cache@v5
        with:
          path: tests/build
          key: tests-${{ runner.os }}-${{ hashFiles('tests/**/*.cpp', 'tests/**/*.hpp', 'tests/Makefile', 'src/**/*.hpp') }}
          restore-keys: |
            tests-${{ runner.os }}-

      - name: Build project and tests
        run: |
          make
          cd tests/
          make

      - name: Run Port tests
        run: |
          cd tests/
          ./bin/test_runner --gtest_filter='PortTest.*' --gtest_output=xml:test-results-port.xml

      - name: Run Port tests with Valgrind
        run: |
          cd tests/
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --error-exitcode=1 --log-file=valgrind-port.txt ./bin/test_runner --gtest_filter='PortTest.*'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-port
          path: |
            tests/test-results-port.xml
            tests/valgrind-port.txt

      - name: Test Summary
        if: always()
        run: |
          echo "## Port Test Results" >> $GITHUB_STEP_SUMMARY
          cd tests/
          if [ -f test-results-port.xml ]; then
            echo "âœ… Port tests completed" >> $GITHUB_STEP_SUMMARY
          fi
