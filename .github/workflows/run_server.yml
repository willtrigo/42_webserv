name: Run Server

on:
  push:
    branches: [ main, master, develop, "**feat**" ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake valgrind
    
    - name: Cache project build
      uses: actions/cache@v5
      with:
        path: |
          build
          bin
        key: project-build-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.hpp', 'Makefile') }}
        restore-keys: |
          project-build-${{ runner.os }}-
    
    - name: Build project
      run: |
        make
    
    - name: Run server without config
      run: |
        echo "üöÄ Testing server without config file..."
        timeout 5s ./bin/webserv || EXIT_CODE=$?
        
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "‚úÖ Server ran without config for 5 seconds"
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "‚úÖ Server completed without config"
        else
          echo "‚ö†Ô∏è Server exited with code ${EXIT_CODE} (may be expected)"
        fi
    
    - name: Discover config files
      id: configs
      run: |
        echo "üìÇ Scanning conf/ directory..."
        if [ ! -d conf ]; then
          echo "‚ùå conf/ directory not found"
          exit 1
        fi
        
        CONFIG_FILES=$(find conf -name "*.conf" -type f | sort)
        if [ -z "$CONFIG_FILES" ]; then
          echo "‚ùå No .conf files found in conf/"
          exit 1
        fi
        
        echo "‚úÖ Found config files:"
        echo "$CONFIG_FILES" | while read file; do
          echo "  - $file"
        done
        
        # Save for next steps
        echo "$CONFIG_FILES" > config_files.txt
        echo "config_count=$(echo "$CONFIG_FILES" | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Test each config file
      run: |
        echo "üß™ Testing each configuration file..."
        RESULTS_FILE="test_results.txt"
        echo "Configuration Test Results" > $RESULTS_FILE
        echo "==========================" >> $RESULTS_FILE
        echo "" >> $RESULTS_FILE
        
        TOTAL=0
        SUCCESS=0
        FAILED=0
        
        while read CONFIG_FILE; do
          TOTAL=$((TOTAL + 1))
          echo "" >> $RESULTS_FILE
          echo "üìã Testing: $CONFIG_FILE" | tee -a $RESULTS_FILE
          echo "---" >> $RESULTS_FILE
          
          # Show config content
          echo "Config content:" >> $RESULTS_FILE
          cat "$CONFIG_FILE" >> $RESULTS_FILE
          echo "" >> $RESULTS_FILE
          
          # Run server with config
          timeout 8s ./bin/webserv "$CONFIG_FILE" 2>&1 | tee -a $RESULTS_FILE || EXIT_CODE=$?
          
          if [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo "‚úÖ Success: Server ran for 8 seconds" | tee -a $RESULTS_FILE
            SUCCESS=$((SUCCESS + 1))
          elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo "‚úÖ Success: Server completed normally" | tee -a $RESULTS_FILE
            SUCCESS=$((SUCCESS + 1))
          else
            echo "‚ùå Failed: Exit code ${EXIT_CODE}" | tee -a $RESULTS_FILE
            FAILED=$((FAILED + 1))
          fi
          
          echo "" >> $RESULTS_FILE
        done < config_files.txt
        
        # Summary
        echo "" >> $RESULTS_FILE
        echo "==========================" >> $RESULTS_FILE
        echo "üìä SUMMARY" >> $RESULTS_FILE
        echo "==========================" >> $RESULTS_FILE
        echo "Total configs tested: $TOTAL" >> $RESULTS_FILE
        echo "Successful: $SUCCESS" >> $RESULTS_FILE
        echo "Failed: $FAILED" >> $RESULTS_FILE
        
        # Display summary
        cat $RESULTS_FILE
        
        # Exit with error if any failed
        if [ $FAILED -gt 0 ]; then
          echo ""
          echo "‚ùå $FAILED configuration(s) failed"
          exit 1
        else
          echo ""
          echo "‚úÖ All $SUCCESS configuration(s) passed"
        fi
    
    - name: Rebuild for Valgrind (compatible instruction set)
      run: |
        echo "üîß Rebuilding with Valgrind-compatible CPU flags..."
        make clean
        CXXFLAGS="-mno-avx512f -mno-avx2" make
    
    - name: Run Valgrind on primary config
      run: |
        echo "üîç Running Valgrind on primary config..."
        PRIMARY_CONFIG=$(head -1 config_files.txt)
        echo "Testing: $PRIMARY_CONFIG"
        
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --log-file=valgrind-server.txt ./bin/webserv "$PRIMARY_CONFIG" || EXIT_CODE=$?
        
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "‚úÖ Valgrind test completed (timeout expected)"
          if [ -f valgrind-server.txt ]; then
            echo "üìã Valgrind summary:"
            tail -20 valgrind-server.txt
          fi
          exit 0
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "‚úÖ Valgrind test completed successfully"
          exit 0
        else
          echo "‚ùå Valgrind detected issues (exit code ${EXIT_CODE})"
          if [ -f valgrind-server.txt ]; then
            cat valgrind-server.txt
          fi
          exit ${EXIT_CODE}
        fi
    
    - name: Upload server logs
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: server-logs
        path: |
          valgrind-server.txt
          test_results.txt
          config_files.txt
    
    - name: Display final summary
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "üìä SERVER VALIDATION SUMMARY"
        echo "=========================================="
        echo ""
        echo "This workflow validates:"
        echo "  ‚úì Server compiles successfully"
        echo "  ‚úì Server runs without config"
        echo "  ‚úì Server accepts all config files in conf/"
        echo "  ‚úì Server runs without crashes"
        echo "  ‚úì No memory leaks detected (Valgrind)"
        echo ""
        if [ -f test_results.txt ]; then
          echo "Test Results Summary:"
          tail -10 test_results.txt
        fi
        echo "=========================================="
