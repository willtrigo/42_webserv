name: Run Server

on:
  push:
    branches: [ main, master, develop, "**feat**" ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake valgrind
    
    - name: Cache project build
      uses: actions/cache@v5
      with:
        path: |
          build
          bin
        key: project-build-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.hpp', 'Makefile') }}
        restore-keys: |
          project-build-${{ runner.os }}-
    
    - name: Build project
      run: |
        make
    
    - name: Verify config file exists
      run: |
        if [ -f conf/webserv.conf ]; then
          echo "‚úÖ Config file found"
          cat conf/webserv.conf
        else
          echo "‚ùå Config file not found"
          exit 1
        fi
    
    - name: Run server with timeout
      run: |
        echo "üöÄ Starting webserver with webserv.conf..."
        timeout 10s ./bin/webserv ./conf/webserv.conf || EXIT_CODE=$?
        
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "‚úÖ Server ran for 10 seconds and was terminated (expected behavior)"
          exit 0
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "‚úÖ Server completed successfully"
          exit 0
        else
          echo "‚ùå Server failed with exit code ${EXIT_CODE}"
          exit ${EXIT_CODE}
        fi
    
    - name: Run server with Valgrind
      run: |
        echo "üîç Running server with Valgrind memory leak detection..."
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --log-file=valgrind-server.txt ./bin/webserv ./conf/webserv.conf || EXIT_CODE=$?
        
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "‚úÖ Valgrind test completed (timeout expected)"
          if [ -f valgrind-server.txt ]; then
            echo "üìã Valgrind summary:"
            tail -20 valgrind-server.txt
          fi
          exit 0
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "‚úÖ Valgrind test completed successfully"
          exit 0
        else
          echo "‚ùå Valgrind detected issues (exit code ${EXIT_CODE})"
          if [ -f valgrind-server.txt ]; then
            cat valgrind-server.txt
          fi
          exit ${EXIT_CODE}
        fi
    
    - name: Upload server logs
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: server-logs
        path: |
          valgrind-server.txt
    
    - name: Test server connectivity (if still running)
      if: always()
      run: |
        echo "üìä Server test completed"
        echo "This workflow validates that the server binary:"
        echo "  1. Compiles successfully"
        echo "  2. Accepts config file argument"
        echo "  3. Starts without immediate crash"
        echo "  4. Runs without memory leaks (Valgrind check)"
